
# Домашнее задание к занятию "Микросервисы: принципы"

Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- Маршрутизация запросов к нужному сервису на основе конфигурации
- Возможность проверки аутентификационной информации в запросах
- Обеспечение терминации HTTPS
```
            Продукт      Kong        Tyk.io        APIGee        AWS Gateway       Azure Gateway         Express Gateway
Сложность
Развертывания           Single        Single        Many           Cloud               Cloud                 Flexible

Локальное
Развертывание             Yes           Yes           Yes            No                  No                    Yes

Авторизация/API Key       Yes           Yes           Yes            Yes                 Yes                   Yes

Rate Limiting             Yes           Yes           Yes            Yes                 Yes                   Yes

Data Transformation       HTTP          HTTP          Yes            No                   No                    No 

request-
Termination                Yes          Не нашел      Не нашел       Yes                 Yes                   Yes
```
1. Конфигурировать можно любое предоставленное выше решение (например в AWS использует сервис Lambda  в котором записываются функции обработчики запросов)
2. Все API поддерживают аутентификацию.
3. Многие решения поддерживают терминацию

Если продукт не использует много запросов или необходима легкость развертывания, можно использовать облачные решения.Если необходима независимость и гибкость в управлении  лучше  использовать open source решения.

Обоснуйте свой выбор.
```
https://www.altexsoft.com/blog/api-gateway/
https://www.moesif.com/blog/technical/api-gateways/How-to-Choose-The-Right-API-Gateway-For-Your-Platform-Comparison-Of-Kong-Tyk-Apigee-And-Alternatives/
https://babok-school.ru/blogs/integration-api-overview-rest-soap-grpc-graphql/
```
## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.
```
                               Apache          RabbitMQ          Redis   
                               Kafka                                        
Поддержка кластеризации
для обеспечения надежности       +                 +               + (R3.0)

Хранение сообщений на диске
в процессе доставки              +                 -                - 

Высокая скорость работы          +                 +                +

Поддержка различных 
форматов сообщений               -                  +               +

Разделение прав доступа
к различным потокам сообщений    +                  +               -

Проcтота эксплуатации            +                  +               +
```
Решение должно соответствовать следующим требованиям:
- Поддержка кластеризации для обеспечения надежности
- Хранение сообщений на диске в процессе доставки
- Высокая скорость работы
- Поддержка различных форматов сообщений
- Разделение прав доступа к различным потокам сообщений
- Проcтота эксплуатации

Kafka. Обладает большой пропускной способностью и отказоустойчивостью, легко масштабируемая система, параллельная обработка потоков сообщений сразу на нескольких серверах, обладающая повышенной отказоустойчивостью, что очень важно в крупных проектах.

Rabbit. Гибкая маршрутизация сообщений.  Rabbit реализует концепцию push-доставки, важен сам факт доставки сообщений, но порядок доставки не принципиален. Решение подходит для систем бронирования билетов, логистических программ и микросервисных приложений.

Radis. Низкая задержка доставки сообщений, поддержка множества протоколов и форматов данных. Redis нельзя назвать универсальным брокером сообщений, поскольку он не гарантирует 100% доставку сообщений в случае сбоя или отказа узла.

```
https://timeweb.cloud/tutorials/redis/broker-soobshchenij-redis
https://mcs.mail.ru/blog/rabbitmq-ili-apache-kafka

```
## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- Хранит загруженные файлы в бакете images
- S3 протокол

**uploader**
- Принимает файл, если он картинка сжимает и загружает его в minio
- POST /v1/upload

**security**
- Регистрация пользователя POST /v1/user
- Получение информации о пользователе GET /v1/user
- Логин пользователя POST /v1/token
- Проверка токена GET /v1/token/validation

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
- Анонимный доступ.
- Запрос направляется в сервис security POST /v1/user

**POST /v1/token**
- Анонимный доступ.
- Запрос направляется в сервис security POST /v1/token

**GET /v1/user**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис security GET /v1/user

**POST /v1/upload**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис uploader POST /v1/upload

**GET /v1/user/{image}**
- Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/
- Запрос направляется в сервис minio  GET /images/{image}

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизаци
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
